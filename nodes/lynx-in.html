<script type="text/javascript">
    RED.nodes.registerType('lynx-in', {
        category: 'IoT Open',
        color: "#12b1be",
        defaults: {
            server: {value: "", type: "lynx-server"},
            installation_id: {value: 0, required: true},
            function_id: {value: 0, required: true},
            function_name: {value: ""},
            topic: {value: ""},
            client_id: {value: 0},
        },
        inputs: 0,
        outputs: 1,
        icon: "lynx-in.png",
        label: function () {
            return this.function_name || "lynx-in"
        },
        oneditprepare: function () {
            let node = this;
            let functions = [];
            let installations = [];
            let selectedServer = RED.nodes.node(node.server.id ? node.server.id : node.server);
            let selectedInstallation = node.installation_id;
            let selectedFunction = node.function_id;

            let serverSelected = () => {
                let selectFirst = true;
                node.server = selectedServer.id;

                $.getJSON('lynx/installations', {
                    url: selectedServer.url,
                    apiKey: selectedServer.api_key,
                }, function (data) {
                    let select = $("select#node-input-installation_id");
                    select.empty();
                    if (Array.isArray(data)) {
                        installations = data;
                        installations.map(installation => {
                            let selected = selectedInstallation === installation.id;
                            select.append(new Option(installation.name, installation.id, selected, selected));
                            if (selected) {
                                selectFirst = false;
                                selectedInstallation = installation.id;
                                installationSelected(selectedInstallation);
                            }
                        });
                        if (selectFirst && installations.length > 0) {
                            selectedInstallation = installations[0].id;
                            installationSelected(selectedInstallation);
                        }
                    }
                });
            }

            let installationSelected = (installationId) => {
                installations.map(installation => {
                    if (selectedInstallation.toString() === installation.id.toString()) {
                        node.installation_id = installation.id;
                        node.client_id = installation.client_id;
                    }
                });
                let selectFirst = true;
                $.getJSON('lynx/functions/' + installationId, {
                    url: selectedServer.url,
                    apiKey: selectedServer.api_key,
                }, function (data) {
                    if (selectedInstallation === installationId) {
                        let select = $("select#node-input-function_id");
                        select.empty();
                        if (Array.isArray(data)) {
                            functions = data.sort((a,b) => {
                                 return a.meta.name.toLowerCase().localeCompare(b.meta.name.toLowerCase());
                            });
                            functions.map(fun => {
                                let selected = selectedFunction === fun.id;
                                select.append(new Option(fun.meta.name, fun.id, selected, selected));
                                if (selected) {
                                    selectFirst = false;
                                    selectedFunction = fun.id;
                                    functionSelected();
                                }
                            });
                            if (selectFirst && functions.length > 0) {
                                selectedFunction = functions[0].id;
                                functionSelected();
                            }
                        }
                    }
                });
            }

            let functionSelected = () => {
                functions.map(fun => {
                    if (fun.id === selectedFunction) {
                        RED.nodes.dirty(node.function_id !== selectedFunction);
                        node.function_id = fun.id;
                        node.function_name = fun.meta.name;
                        let inputType = $("#node-input-type");
                        inputType.empty();

                        let selectFirst = true;
                        for (let key in fun.meta) {
                            if (fun.meta.hasOwnProperty(key) && key.startsWith("topic_")) {
                                let topicButton = getTopicButton(key, fun.meta[key]);
                                inputType.append(topicButton);
                                if (fun.meta[key] === node.topic) {
                                    selectFirst = false;
                                    topicButton.click();
                                }
                            }
                        }
                        if (selectFirst) {
                            let btns = $("#node-input-type").children(":button");
                            if (btns.length > 0) btns[0].click();
                        }
                    }
                });
            }

            let getTopicButton = (metaKey, metaValue) => {
                let metaType = metaKey.substring(metaKey.indexOf('_') + 1, metaKey.length);
                let btn = $('<button type="button" id="type-' + metaType + '" value="' + metaValue + '" class="red-ui-button toggle type-button-group">' + metaType + '<button/>');
                if (node.topic === metaValue) {
                    btn.addClass("selected");
                }
                btn.click(function () {
                    $(".type-button-group").removeClass("selected");
                    $(this).addClass("selected");
                    val = $(this).val()
                    RED.nodes.dirty(node.topic !== val)
                    node.topic = val;
                });
                return btn[0];
            }

            $("select#node-input-server").change(function (e) {
                if (!e.isTrigger) {
                    let val = $(this).val();
                    selectedServer = RED.nodes.node(val ? val : node.server);
                    if (selectedServer) {
                        serverSelected();
                    }
                }
            });

            $("select#node-input-installation_id").change(function (e) {
                if (!e.isTrigger) {
                    let val = $(this).val();
                    selectedInstallation = val ? parseInt(val) : node.installation_id;
                    if (selectedServer) {
                        installationSelected(selectedInstallation);
                    }
                }
            });

            $("select#node-input-function_id").change(function (e) {
                if (!e.isTrigger) {
                    let val = $(this).val();
                    selectedFunction = val ? parseInt(val) : node.function_id;
                    if (selectedServer) {
                        functionSelected();
                    }
                }
            });
            if (selectedServer) {
                serverSelected();
            }
        },
    });
</script>

<script type="text/html" data-template-name="lynx-in">
    <div class="form-row">
        <label for="node-input-server"><i class="icon-bookmark"></i> Server</label>
        <input type="text" id="node-input-server">
    </div>
    <div class="form-row">
        <label for="node-input-installation_id"><i class="icon-tag"></i> Installation</label>
        <select id="node-input-installation_id">
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-function_id"><i class="icon-tag"></i> Function</label>
        <select id="node-input-function_id">
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-type"><i class="icon-tag"></i> Topic</label>
        <span id="node-input-type" class="button-group"></span>
    </div>
</script>

<script type="text/html" data-help-name="lynx-in">
    <p>
        A node for receiving data from a function on a Lynx server. In the
        properties: server, installation, function and what topic to get data
        from is set. The data from that function is then sent from the node
        when it arrives.
    </p>
    <h3>
        Output
    </h3>
    <p>
        The output has <code>msg.payload</code> set to the data from Lynx and
        the <code>msg.topic</code> is set to the topic used in Lynx to identify
        the data.
        Some additional data for the selected configuration is also included in
        the output to allow chaining with other Lynx nodes.
    </p>
</script>
