<script type="text/javascript">
    RED.nodes.registerType('lynx-notification', {
        category: 'IoT Open',
        color: "#12b1be",
        defaults: {
            server: {value: "", type: "lynx-server"},
            installation_id: {value: 0, required: true},
            output_id: {value: 0, required: true},
            output_name: {value: "", },
            executor_id: {value: 0, required: true},
            message_id: {value: 0, required: true},
        },
        inputs: 1,
        outputs: 0,
        icon: "lynx-notification.png",
        label: function () {
            return this.output_name || "lynx-notification"
        },
        oneditsave: function () {
            let node = this;
            let selectedServer = RED.nodes.node(node.server.id ? node.server.id : node.server);
            let output = $("#node-input-output_name").val();
            let getConfig = () => {
                let eList = $("#node-input-config-container").editableList('items');
                let res = {};
                eList.each(function(i) {
                    let configProp = $(this);
                    let propName = configProp.find(".node-input-config-property-name").val()
                    let propValue = configProp.find(".node-input-config-property-value").val()
                    res[propName] = propValue
                });
                return res
            }
            let config = getConfig() 
            if (node.output_id !== 0) {
                $.ajax({url: '/lynx/notification/output', 
                    type: "PUT",
                    data: {
                        url: selectedServer.url,
                        apiKey: selectedServer.api_key,
                        id: node.output_id,
                        name: output,
                        installation_id: node.installation_id,
                        executor_id: node.executor_id,
                        message_id: node.message_id,
                        config: config,
                    },
                    success: function (data){
                        node.output_name = data.name
                    }
                });
                return
            }
            $.post('lynx/notification/output', {
                url: selectedServer.url,
                apiKey: selectedServer.api_key,
                name: output,
                installation_id: node.installation_id,
                executor_id: node.executor_id,
                message_id: node.message_id,
                config: config,
            }).done(function(data){
                node.output_id = data.id
                node.output_name = data.name
            })
        },
        oneditprepare: function() {
            let outputs = [];
            let executors = [];
            let messages = [];
            let installations = [];
            let node = this;
            let selectedServer = RED.nodes.node(node.server.id ? node.server.id : node.server);
            let selectedInstallation = node.installation_id;
            let selectedOutput = node.output_id;
            let selectedExecutor = node.executor_id;
            let selectedMessage = node.message_id;

            let sectionInit = () => {
                let section = $("#node-section-output");
                let paletteHeader = section.find('.red-ui-palette-header');
                let twistie = paletteHeader.find('i');
                let sectionContent = section.find('.section-content');
                let isExpanded = selectedOutput === 0
                    || selectedExecutor === 0
                    || selectedMessage === 0;
                function toggleSection(expanded) {
                    twistie.toggleClass('expanded', expanded);
                    sectionContent.toggle(expanded);
                }
                paletteHeader.click(function() {
                    let isExpanded = twistie.hasClass('expanded');
                    toggleSection(!isExpanded);
                });
                toggleSection(isExpanded);
            }
            let eList = $('#node-input-config-container');
            eList.editableList({
                addItem: function(container, index, data) {
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap'
                    });
                    let row = $('<div/>').appendTo(container);
                    let propertyName = $('<input/>',{class:"node-input-config-property-name",type:"text"}).css("width","30%").appendTo(row);
                    $('<div/>',{style: 'display:inline-block; padding:0px 6px;'}).text('=').appendTo(row);
                    let propertyValue = $('<input/>',{class:"node-input-config-property-value",type:"text"}).css("width","calc(70% - 30px)").appendTo(row);
                    propertyName.val(data.key);
                    propertyValue.val(data.value);
                },
                removable: true,
                sortable: false
            });
            let serverSelected = () => {
                let selectFirst = true;
                node.server = selectedServer.id;
                $.getJSON('lynx/installations', {
                    url: selectedServer.url,
                    apiKey: selectedServer.api_key,
                }, function (data) {
                    let select = $("select#node-input-installation_id");
                    select.empty();
                    if (Array.isArray(data)) {
                        installations = data;
                        installations.map(installation => {
                            let selected = selectedInstallation === installation.id;
                            select.append(new Option(installation.name, installation.id, selected, selected));
                            if (selected) {
                                selectFirst = false;
                                selectedInstallation = installation.id;
                                installationSelected(selectedInstallation);
                            }
                        });
                        if (selectFirst && installations.length > 0) {
                            selectedInstallation = installations[0].id;
                            installationSelected(selectedInstallation);
                        }
                    }
                });
            }

            let installationSelected = (installationId) => {
                installations.map(installation => {
                    if (selectedInstallation.toString() === installation.id.toString()) {
                        node.installation_id = installation.id;
                    }
                });
                $.getJSON('/lynx/notification/executors' + selectedInstallation, {
                    url: selectedServer.url,
                    apiKey: selectedServer.api_key,
                }, function (data) {
                    let select = $("select#node-input-executor_id");
                    select.empty();
                    if (Array.isArray(data)) {
                        executors = data;
                        executors.map(executor => {
                            let selected = selectedExecutor === executor.id;
                            select.append(new Option(executor.name, executor.id, selected, selected));
                            if (selected) {
                                selectedExecutor();
                            }
                        });
                    }
                });
                $.getJSON('/lynx/notification/messages' + selectedInstallation, {
                    url: selectedServer.url,
                    apiKey: selectedServer.api_key,
                }, function (data) {
                    let select = $("select#node-input-message_id");
                    select.empty();
                    if (Array.isArray(data)) {
                        messages = data;
                        messages.map(message => {
                            let selected = selectedMessage === message.id;
                            select.append(new Option(message.name, message.id, selected, selected));
                            if (selected) {
                                selectedMessage();
                            }
                        });
                    }
                });
                let selectFirst = true;
                $.getJSON('/lynx/notification/outputs' + installationId, {
                    url: selectedServer.url,
                    apiKey: selectedServer.api_key,
                }, function (data) {
                    if (selectedInstallation === installationId) {
                        let select = $("select#node-input-output_id");
                        select.empty();
                        if (Array.isArray(data)) {
                            outputs = data;
                            outputs.map(output => {
                                let selected = selectedOutput === output.id;
                                select.append(new Option(output.name, output.id, selected, selected));
                                if (selected) {
                                    selectFirst = false;
                                    outputSelected();
                                }
                            });
                            if (selectFirst && outputs.length > 0) {
                                selectedOutput = outputs[0].id;
                                outputSelected();
                            }
                        }
                    }
                });
            }
            let outputSelected = () => {
                outputs.map(output => {
                    if (selectedOutput == output.id) {
                        RED.nodes.dirty(node.output_id !== selectedOutput);
                        node.output_name = output.name;
                        node.output_id = output.id;
                        eList.empty();
                        $("#node-input-output_name").val(output.name);
                        Object.keys(output.config).map( key => {
                            let config = {
                                key: key,
                                value: output.config[key],
                            }
                            eList.editableList('addItem', config);
                        });
                        selectedExecutor = output.notification_output_executor_id;
                        selectedMessage = output.notification_message_id;
                        messageSelected();
                        executorSelected();
                    }
                });
            }
            
            let messageSelected = () => {
                messages.map(message => {
                    if (selectedMessage === message.id) {
                        node.message_id = message.id;
                        $("#node-input-message_name").val(message.name);
                        $("#node-input-message_text").val(message.text);
                    }
                });
            }

            let executorSelected = () => {
                executors.map(executor => {
                    if (selectedExecutor === executor.id) {
                        node.executor_id = executor.id;
                    }
                });
            }
            
            $("select#node-input-server").change(function (e) {
                if (!e.isTrigger) {
                    let val = $(this).val();
                    selectedServer = RED.nodes.node(val ? val : node.server);
                    if (selectedServer) {
                        serverSelected();
                    }
                }
            });

            $("select#node-input-installation_id").change(function (e) {
                if (!e.isTrigger) {
                    let val = $(this).val();
                    selectedInstallation = val ? parseInt(val) : node.installation_id;
                    if (selectedServer) {
                        installationSelected(selectedInstallation);
                    }
                }
            });

            $("select#node-input-output_id").change(function (e) {
                if (!e.isTrigger) {
                    let val = $(this).val();
                    selectedOutput = val ? parseInt(val) : node.output_id;
                    if (selectedServer) {
                        outputSelected(selectedInstallation);
                    }
                }
            });
            
            $("select#node-input-message_id").change(function (e) {
                if (!e.isTrigger) {
                    let val = $(this).val();
                    selectedMessage = val ? parseInt(val) : node.message_id;
                    messageSelected();
                }
            });  

            $("select#node-input-executor_id").change(function (e) {
                if (!e.isTrigger) {
                    let val = $(this).val();
                    selectedExecutor = val ? parseInt(val) : node.executor_id;
                    executorSelected();
                }
            });

            $("#node-message-edit").click(function () {
                if (selectedMessage === 0) {
                    return
                }
                $(".content-props").hide();
                $(".content-message").show();
            });

            $("#node-message-edit-return").click(function () {
                $(".content-props").show();
                $(".content-message").hide();
                $("#node-input-message_id").change();
            });

            $("#node-message-create").click(function () {
                selectedMessage = 0;
                $("#node-input-message_name").val("");
                $("#node-input-message_text").val("");
                $(".content-props").hide();
                $(".content-message").show();
            });

            $("#node-message-edit-save").click(function () {
                let name = $("#node-input-message_name").val();
                let text = $("#node-input-message_text").val();
                if (selectedMessage === 0) {
                    $.post('lynx/notification/message', {
                        url: selectedServer.url,
                        apiKey: selectedServer.api_key,
                        name: name,
                        text: text,
                        installation_id: selectedInstallation,
                    }).done( function (data){
                        selectedMessage = data.id
                        messages.push(data)
                        let select = $("select#node-input-message_id");
                        select.append(new Option(data.name, data.id, true, true));
                    });
                } else if(selectedMessage !== 0) {
                    $.ajax({url: 'lynx/notification/message', 
                        type: "PUT",
                        data: {
                            url: selectedServer.url,
                            apiKey: selectedServer.api_key,
                            id: selectedMessage,
                            name: name,
                            text: text,
                            installation_id: selectedInstallation,
                        },
                        success: function (data){
                            messages.map(message => {
                                if (message.id == data.id) {
                                    message = data;
                                }
                            });
                        }
                    });
                }
                $(".content-message").hide();
                $(".content-props").show();
            });
            
            $("#node-output-create").click(function () {
                selectedOutput = 0;
                node.output_id = 0;
                outputs.map(output => {
                    if (selectedOutput === output.id) {
                        return
                    }
                })
                let select = $("select#node-input-output_id");
                select.append(new Option("Add new output", 0, true, true));
                $("#node-input-output_name").val("");
                eList.empty()
            })
            if (selectedServer) {
                serverSelected();
            }
            sectionInit();
        },
    });
</script>

<script type="text/html" data-template-name="lynx-notification">
    <div class="content-props">
         <div class="form-row">
            <label for="node-input-server"><i class="icon-bookmark"></i> Server</label>
            <input type="text" id="node-input-server">
        </div>
        <div class="form-row">
            <label for="node-input-installation_id"><i class="icon-tag"></i> Installation</label>
            <select id="node-input-installation_id"></select>
        </div>
        <div class="form-row">
            <label for="node-input-output_id"><i class="icon-tag"></i> Output</label>
            <select id="node-input-output_id"></select>
            <button id="node-output-create" type="button" class="red-ui-button"><i class="fa fa-plus"></i></button>
        </div>
        <div class="form-row">
            <ul style="min-width: 600px; margin-bottom: 20px;" id="node-input-tabs"></ul>
        </div>
        <div id="node-section-output">
             <div class="red-ui-palette-header">
                 <i class="fa fa-angle-down"></i><span>Output configuration</span>
             </div>
             <div class="section-content" style="padding:10px 0 0 10px">
                 <div class="form-row">
                     <label for="output-name"><i class="icon-tag"></i> Name </label>
                     <input type="text" id="node-input-output_name">
                 </div>
                 <div class="form-row">
                     <label for="node-input-executor_id"> <i class="icon-tag"></i> Executor </label>
                     <select id="node-input-executor_id"></select>
                 </div>
                 <div class="form-row">
                     <label for="node-input-message_id"> <i class="icon-bookmark"></i> Message </label>
                     <select id="node-input-message_id"></select>
                     <button id="node-message-edit" type="button" class="red-ui-button"><i class="fa fa-pencil"></i></button>
                     <button id="node-message-create" type="button" class="red-ui-button"><i class="fa fa-plus"></i></button>
                 </div>
                 <div class="form-row node-input-config-container-row">
                     <ol id="node-input-config-container" style="min-width: 450px; min-height: 240px;"></ol>
                 </div>
             </div>
         </div>
       
    </div>
    <div class="content-message" style="display: none;" >
        <div class="red-ui-tray-toolbar">
            <button id="node-message-edit-return" type="button" class="red-ui-button leftButton"><i class="fa fa-arrow-left"></i></button>
            <button id="node-message-edit-save" type="button" class="red-ui-button ui-corner-all"> Save </button>
        </div>
        <div class="form-row">
            <label for="message-name"><i class="icon-tag"></i> Name </label>
            <input type="text" id="node-input-message_name">
        </div>
        <div class="form-row">
            <label for="message-text"><i class="icon-tag"></i> Text </label>
            <input type="text" id="node-input-message_text">
        </div>
    </div>
</script>

<script type="text/html" data-help-name="lynx-notification">
    <p>
        A node for sending notifications using the lynx platform.
        More information about configuring notifications can be found 
        <a href="https://lynx.iotopen.se/tech/docs/notifications/">here.</a> 
    </p>
    <h3>Input</h3>
    <p>
        The input takes any object wich will be sent to the platforms notification-output.
    </p>
</script>